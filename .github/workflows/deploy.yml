name: APP - Deploy

on:
  workflow_run:
    workflows: ["APP - CI"]
    types: [completed]

permissions:
  contents: read
  packages: read

concurrency:
  group: web-deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  INFRA_DIR: /opt/palaspapas/infra
  COMPOSE_SERVICE: web
  IMAGE_NAME: fastfood-web

jobs:
  deploy_develop:
    name: Deploy WEB -> develop
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'develop'
    runs-on: [self-hosted, develop]
    environment: develop
    steps:
      - name: Login GHCR (pull)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull & Restart WEB (develop)
        shell: bash
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
          TAG="ghcr.io/${OWNER_LC}/${IMAGE_NAME}:sha-${SHORT_SHA}"

          cd "${INFRA_DIR}"

          export IMAGE_TAG_WEB="${TAG##*:}"
          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true

  deploy_prod:
    name: Deploy WEB -> prod 
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: [self-hosted, prod]
    environment: production
    steps:
      - name: Login GHCR (pull)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull & Restart WEB (prod)
        shell: bash
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
          TAG="ghcr.io/${OWNER_LC}/${IMAGE_NAME}:sha-${SHORT_SHA}"

          cd "${INFRA_DIR}"

          export IMAGE_TAG_WEB="${TAG##*:}"
          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true
