<form class="form" [formGroup]="form" (ngSubmit)="onSubmit()" autocomplete="off">
  <app-section-container [heading]="'Ajuste Manual de Inventario'" [compact]="true" [divider]="true" [inset]="true">
    <div class="fg">
      <app-select label="Ingrediente" [formGroup]="form" controlName="ingredienteId" [items]="ingredientes"
        [soft]="true" [disabled]="loading" [includeNull]="true" nullLabel="-- Seleccione un ingrediente --"
        labelKey="nombre" valueKey="id" [required]="true">
        <ng-template #itemTemplate let-item>
          <div>
            <span>{{ item.nombre }}</span>
            <span class="form-help">Stock: {{ item.stockActual }} {{ item.unidad }}</span>
          </div>
        </ng-template>
      </app-select>

      <app-select label="Tipo de Ajuste" [formGroup]="form" controlName="tipoAjuste" [items]="tiposAjuste"
        [soft]="true" [disabled]="loading" labelKey="label" valueKey="value" [required]="true">
      </app-select>

      <app-input type="numeric" label="Cantidad" [formGroup]="form" controlName="cantidad" [soft]="true"
        [disabled]="loading" [min]="1" placeholder="0" [required]="true">
        <ng-template #helpText>
          <span *ngIf="form.controls.tipoAjuste.value === 'SUMAR'">
            <lucide-icon [img]="Plus" [size]="12"></lucide-icon>
            Cantidad a sumar al inventario
          </span>
          <span *ngIf="form.controls.tipoAjuste.value === 'RESTAR'">
            <lucide-icon [img]="Minus" [size]="12"></lucide-icon>
            Cantidad a restar del inventario (merma, vencimiento, etc.)
          </span>
        </ng-template>
      </app-input>

      <div class="form-field" *ngIf="form.controls.tipoAjuste.value === 'RESTAR'">
        <label>
          <input type="checkbox" formControlName="permitirNegativo" [disabled]="loading">
          <span>Permitir stock negativo</span>
        </label>
        <p class="form-help">
          Marque esta opción solo si desea permitir que el stock quede en negativo después del ajuste
        </p>
      </div>

      <app-input type="textarea" label="Motivo (observaciones)" [formGroup]="form" controlName="referencia" [soft]="true"
        [disabled]="loading" placeholder="Ej: Merma por vencimiento, Compra directa, etc.">
        <ng-template #helpText>
          Descripción opcional del motivo del ajuste
        </ng-template>
      </app-input>
    </div>
  </app-section-container>

  <app-section-container *ngIf="form.controls.ingredienteId.value" [heading]="'Vista Previa del Ajuste'"
    [compact]="true" [divider]="true" [inset]="true">
    <div class="fg">
      <app-summary label="Stock Actual" [value]="getStockActual() + ' ' + getUnidad()"
        variant="info" size="sm">
      </app-summary>

      <app-summary label="Stock Resultante"
        [value]="calcularStockResultante() + ' ' + getUnidad()"
        [variant]="calcularStockResultante() < 0 ? 'danger' : 'success'"
        size="sm">
      </app-summary>
    </div>

    <div *ngIf="calcularStockResultante() < 0" class="pill pill--danger">
      <p>
        Advertencia: El stock resultante es negativo ({{ calcularStockResultante() }}).
      </p>
      <p *ngIf="!form.controls.permitirNegativo.value">
        Para permitir que el stock quede negativo, marque la opción "Permitir stock negativo" arriba.
        De lo contrario, el backend rechazará esta operación.
      </p>
      <p *ngIf="form.controls.permitirNegativo.value">
        Está permitiendo que el stock quede negativo. Use esta opción con precaución.
      </p>
    </div>
  </app-section-container>

  <app-save-cancel [saveLabel]="'Guardar Ajuste'" [cancelLabel]="'Cancelar'" [loading]="loading"
    [disabled]="form.invalid" [sticky]="true" (cancel)="cancel()">
  </app-save-cancel>
</form>
