<app-page-layout [headerTemplate]="headerT" [contentTemplate]="contentT"></app-page-layout>

<!-- HEADER -->
<ng-template #headerT>
  <app-title [titleLabel]="titleLabel" [subtitle]="subTitleLabel" [showBack]="true" variant="tinted" tone="brand"
    (cancel)="goBack()">
  </app-title>
</ng-template>

<!-- CONTENT -->
<ng-template #contentT>
  <!-- Tabs -->
  <app-tabs-filter [items]="[
    { key:'all',     label:'Todos',    count:counters.all,     tone:'brand'   },
    { key:'COMPRA',  label:'Compras',  count:counters.COMPRA,  tone:'success' },
    { key:'CONSUMO', label:'Consumos', count:counters.CONSUMO, tone:'warn'    },
    { key:'AJUSTE',  label:'Ajustes',  count:counters.AJUSTE,  tone:'warn'   }
  ]" [active]="tab" (activeChange)="setTab($any($event))">
  </app-tabs-filter>

  <!-- Filtros de Búsqueda -->
  <app-section-container [heading]="'Filtros de Búsqueda'" [compact]="true" [inset]="true">
    <div class="fg">
        <app-select [label]="'Ingrediente'" [formGroup]="searchForm" controlName="ingredienteId" [items]="ingredientes"
          labelKey="nombre" valueKey="id" [required]="true" [soft]="true" [includeNull]="true"
          nullLabel="Seleccionar ingrediente" hint="Requerido para ver movimientos">
        </app-select>
      <!-- Rango de Fechas -->
        <app-date-range labelFrom="Fecha Desde" labelTo="Fecha Hasta" [valueFrom]="searchForm.controls.fechaDesde.value"
          [valueTo]="searchForm.controls.fechaHasta.value"
          (valueFromChange)="searchForm.controls.fechaDesde.setValue($event)"
          (valueToChange)="searchForm.controls.fechaHasta.setValue($event)" hintFrom="Inicio del rango"
          hintTo="Fin del rango">
        </app-date-range>
    </div>
  </app-section-container>

  <!-- Stock del Ingrediente Seleccionado -->
  <app-section-container *ngIf="searchForm.controls.ingredienteId.value" [heading]="'Stock Actual'"
    [compact]="true" [inset]="true">
    <app-summary label="Stock Actual del Ingrediente"
      [value]="getStockActualIngrediente() + ' ' + getUnidadIngrediente()"
      [variant]="getStockActualIngrediente() === 0 ? 'danger' : 'primary'"
      size="sm">
    </app-summary>
  </app-section-container>

  <!-- Tabla -->
  <div class="card overflow-hidden">
    <app-table [columns]="columns" [rows]="rows" [loading]="loading" [emptyText]="'No hay movimientos de inventario'"
      [sort]="{ key: sortKey, dir: sortDir }" (sortChange)="onSort($event)">
    </app-table>

    <!-- Paginación -->
    <app-paginator class="mt-2" [from]="from()" [to]="to()" [total]="total" [pageIndex]="page" [pageSize]="pageSize"
      [pageSizeOptions]="[10,20,30,50]" [maxPage]="maxPage()" (sizeChange)="setPageSize($event)" (prev)="prev()"
      (next)="next()">
    </app-paginator>
  </div>
</ng-template>