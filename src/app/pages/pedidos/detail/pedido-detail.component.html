<div *ngIf="loading" class="flex justify-center items-center py-12">
  <div class="skeleton h-64 w-full"></div>
</div>

<div *ngIf="!loading && pedido" class="form">
  <!-- Cabecera del Pedido -->
  <app-detail-header [title]="'Pedido #' + pedido.id" [fields]="headerFields"></app-detail-header>

  <!-- Items del Pedido -->
  <app-section-container [heading]="'Items del Pedido'" [compact]="true" [divider]="true" [inset]="true">
    <div class="space-y-3">
      <div *ngFor="let item of pedido.items" class="card p-4 bg-white border border-slate-200">
        <!-- Header del item -->
        <div class="flex justify-between items-start mb-3">
          <div>
            <h4 class="font-bold text-slate-900 text-lg">{{ item.platoNombre }}</h4>
            <div class="text-sm text-slate-600 mt-1">
              <span class="font-medium">Cantidad:</span> {{ item.cantidad }} × ${{ item.precioUnitario?.toFixed(2) }}
              = <span class="font-semibold text-slate-800">${{ (item.precioUnitario! * item.cantidad).toFixed(2) }}</span>
            </div>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-orange-600">${{ calcularSubtotalItem(item).toFixed(2) }}</p>
          </div>
        </div>

        <!-- Descuento -->
        <div *ngIf="item.descuentoPct && item.descuentoPct > 0" class="mb-2 p-2 bg-green-50 rounded text-sm">
          <span class="font-medium text-green-700">Descuento aplicado:</span>
          <span class="text-green-600">{{ item.descuentoPct }}% (-${{ item.descuentoMonto?.toFixed(2) }})</span>
        </div>

        <!-- Extras -->
        <div *ngIf="item.extras && item.extras.length > 0" class="border-t border-slate-200 pt-3">
          <p class="text-sm font-semibold text-slate-700 mb-2">Ingredientes Extras:</p>
          <div class="flex flex-wrap gap-2">
            <div *ngFor="let extra of item.extras" class="px-3 py-1 bg-slate-50 rounded-lg border border-slate-200 text-sm">
              <span class="font-medium text-slate-800">{{ extra.ingredienteNombre }}</span>
              <span class="text-slate-600"> ×{{ extra.cantidad }}</span>
              <span class="text-orange-600 font-semibold ml-1">
                +${{ ((extra.precioExtra || 0) * (extra.cantidad || 0)).toFixed(2) }}
              </span>
              <span class="text-xs text-slate-500 ml-1">(×{{ item.cantidad }})</span>
            </div>
          </div>
          <div *ngIf="calcularTotalExtrasItem(item) > 0" class="mt-2 text-right text-sm">
            <span class="font-medium text-slate-600">Total Extras: </span>
            <span class="font-bold text-orange-600">+${{ calcularTotalExtrasItem(item).toFixed(2) }}</span>
          </div>
        </div>
      </div>
    </div>
  </app-section-container>

  <!-- Totales -->
  <app-section-container [heading]="'Totales'" [compact]="true" [divider]="true" [inset]="true">
    <div class="space-y-3">
      <div class="flex justify-between items-center text-slate-700">
        <span class="font-medium">Subtotal (Platos):</span>
        <span class="text-lg font-semibold">${{ pedido.totalBruto.toFixed(2) }}</span>
      </div>

      <div *ngIf="pedido.totalExtras > 0" class="flex justify-between items-center text-slate-700">
        <span class="font-medium">Total Extras:</span>
        <span class="text-lg font-semibold text-orange-600">+${{ pedido.totalExtras.toFixed(2) }}</span>
      </div>

      <div class="flex justify-between items-center pt-3 border-t-2 border-orange-200">
        <span class="text-xl font-bold text-slate-800">Total del Pedido:</span>
        <span class="text-3xl font-bold text-orange-600">${{ pedido.totalNeto.toFixed(2) }}</span>
      </div>
    </div>
  </app-section-container>

  <!-- Botones de Acción -->
  <app-section-container [heading]="'Acciones'" [compact]="true" [divider]="true" [inset]="true">
    <div class="flex gap-3 flex-wrap">
      <!-- C -> L (Marcar como Listo) -->
      <button *ngIf="pedido.estado === 'C'" type="button" class="btn btn--primary" (click)="onMarcarListo()"
        title="Marcar como Listo (NO descuenta inventario)">
        Marcar como Listo
      </button>

      <!-- L -> E (Entregar) -->
      <button *ngIf="pedido.estado === 'L'" type="button" class="btn btn--success" (click)="onEntregar()"
        title="Entregar pedido (SÍ descuenta inventario)">
        Entregar Pedido
      </button>

      <!-- C, L -> A (Anular) -->
      <button *ngIf="pedido.estado === 'C' || pedido.estado === 'L'" type="button" class="btn btn--danger" (click)="onAnular()"
        title="Anular pedido">
        Anular Pedido
      </button>

      <!-- Mensaje para estados finales -->
      <div *ngIf="pedido.estado === 'E' || pedido.estado === 'A'" class="text-sm text-slate-600 italic">
        Este pedido está en estado final y no se puede modificar.
      </div>
    </div>
  </app-section-container>

  <!-- Botón volver -->
  <div class="flex justify-end mt-6">
    <button type="button" class="btn btn--outline" (click)="goBack()">
      Volver al Listado
    </button>
  </div>
</div>
