<form class="form" [formGroup]="form" (ngSubmit)="onSubmit()" autocomplete="off">
  <div class="space-y-6">
    <!-- Selección de Platos y Extras -->
    <app-section-container [heading]="'Seleccionar Platos'" [compact]="false" [divider]="true" [inset]="true">
      <div class="space-y-6">
        <!-- Plato y Cantidad en una línea -->
        <div class="grid grid-cols-12 gap-4 items-end">
          <div class="col-span-7 form-field">
            <label class="form-label">Plato</label>
            <select [(ngModel)]="platoSeleccionado" [ngModelOptions]="{standalone: true}"
              class="field field--lg" [disabled]="loading">
              <option [ngValue]="null">-- Seleccione un plato --</option>
              <option *ngFor="let plato of platos" [ngValue]="plato.id">
                {{ plato.nombre }} - ${{ plato.precioBase.toFixed(2) }}
              </option>
            </select>
          </div>

          <div class="col-span-5 form-field">
            <label class="form-label">Cantidad</label>
            <div class="flex items-center gap-2">
              <button type="button" class="btn-icon btn-icon--lg btn-icon--outline"
                (click)="cantidadPlato = cantidadPlato > 1 ? cantidadPlato - 1 : 1" [disabled]="loading || cantidadPlato <= 1">
                <lucide-icon [img]="Minus" [size]="20"></lucide-icon>
              </button>
              <input type="number" [(ngModel)]="cantidadPlato" [ngModelOptions]="{standalone: true}" min="1"
                class="field field--lg text-center font-bold flex-1" [disabled]="loading" />
              <button type="button" class="btn-icon btn-icon--lg btn-icon--outline" (click)="cantidadPlato = cantidadPlato + 1"
                [disabled]="loading">
                <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Extras -->
        <div class="space-y-3">
          <label class="form-label">Ingredientes Adicionales</label>

          <div class="grid grid-cols-12 gap-3 items-end">
            <div class="col-span-6 form-field">
              <select [(ngModel)]="ingredienteSeleccionado" [ngModelOptions]="{standalone: true}" class="field field--lg"
                [disabled]="loading">
                <option [ngValue]="null">-- Ingrediente --</option>
                <option *ngFor="let ing of ingredientes" [ngValue]="ing.id">
                  {{ ing.nombre }} (+${{ ing.precioExtra.toFixed(2) }})
                </option>
              </select>
            </div>

            <div class="col-span-3 form-field">
              <input type="number" [(ngModel)]="cantidadExtra" [ngModelOptions]="{standalone: true}" min="1"
                class="field field--lg text-center" placeholder="1" [disabled]="loading" />
            </div>

            <div class="col-span-3">
              <button type="button" class="btn btn--lg btn--primary w-full" (click)="agregarExtraTemp()"
                [disabled]="!ingredienteSeleccionado || cantidadExtra <= 0 || loading">
                <lucide-icon [img]="Plus" [size]="18"></lucide-icon>
                <span>Agregar</span>
              </button>
            </div>
          </div>

          <!-- Lista de extras temporales -->
          <div *ngIf="extrasTemp.length > 0" class="flex flex-wrap gap-2 mt-3">
            <div *ngFor="let extra of extrasTemp; let i = index"
              class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-lg border border-slate-300">
              <span class="font-medium">{{ extra.ingredienteNombre }}</span>
              <span class="text-slate-600">×{{ extra.cantidad }}</span>
              <span class="text-blue-600 font-semibold">${{ (extra.precioExtra * extra.cantidad).toFixed(2) }}</span>
              <button type="button" class="btn-icon btn-icon--xs btn-icon--danger" (click)="removerExtraTemp(i)"
                [disabled]="loading" title="Quitar">
                <lucide-icon [img]="Trash2" [size]="14"></lucide-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Preview del precio -->
        <div *ngIf="platoSeleccionado" class="card p-4 bg-blue-50 border-blue-200">
          <div class="flex justify-between items-center">
            <span class="font-semibold text-slate-700">Precio estimado:</span>
            <span class="text-2xl font-bold text-blue-600">${{ calcularPrecioPreview().toFixed(2) }}</span>
          </div>
        </div>

        <!-- Botón Agregar al carrito -->
        <button type="button" class="btn btn--lg btn--primary w-full" (click)="agregarPlatoAlCarrito()"
          [disabled]="!platoSeleccionado || cantidadPlato <= 0 || loading">
          <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
          <span>Agregar al Pedido</span>
        </button>
      </div>
    </app-section-container>

    <!-- Carrito -->
    <app-section-container [heading]="'Carrito de Pedido'" [compact]="false" [divider]="true" [inset]="true">
      <div *ngIf="carrito.length === 0" class="text-center py-12 text-slate-400">
        <p class="font-medium">El carrito está vacío</p>
      </div>

      <div *ngIf="carrito.length > 0" class="space-y-2">
        <div *ngFor="let item of carrito; let i = index" class="card p-3 bg-white border border-slate-200">
          <div class="grid grid-cols-12 gap-3">
            <!-- Primera fila: Info principal -->
            <div class="col-span-5">
              <h4 class="font-bold text-slate-900">{{ item.platoNombre }}</h4>
              <span class="text-sm text-slate-600">${{ item.precioBas.toFixed(2) }} c/u</span>
            </div>

            <div class="col-span-4 flex items-center gap-2">
              <button type="button" class="btn-icon btn-icon--sm btn-icon--outline" (click)="disminuirCantidad(item)"
                [disabled]="loading || item.cantidad <= 1">
                <lucide-icon [img]="Minus" [size]="14"></lucide-icon>
              </button>
              <span class="font-bold px-2">{{ item.cantidad }}</span>
              <button type="button" class="btn-icon btn-icon--sm btn-icon--outline" (click)="aumentarCantidad(item)"
                [disabled]="loading">
                <lucide-icon [img]="Plus" [size]="14"></lucide-icon>
              </button>
            </div>

            <div class="col-span-2 flex items-center justify-end font-bold text-orange-600">
              ${{ calcularSubtotal(item).toFixed(2) }}
            </div>

            <div class="col-span-1 flex items-center justify-end">
              <button type="button" class="btn-icon btn-icon--xs btn-icon--danger"
                (click)="removerDelCarrito(i)" [disabled]="loading" title="Eliminar">
                <lucide-icon [img]="Trash2" [size]="14"></lucide-icon>
              </button>
            </div>

            <!-- Segunda fila: Extras (si existen) -->
            <div *ngIf="item.extras.length > 0" class="col-span-12 flex flex-wrap gap-1 pt-1 border-t border-slate-100">
              <span class="text-xs text-slate-500 font-medium mr-1">Extras:</span>
              <div *ngFor="let extra of item.extras" class="px-2 py-0.5 bg-slate-50 rounded text-xs">
                {{ extra.ingredienteNombre }} ×{{ extra.cantidad }}
                <span class="text-orange-600 font-semibold">+${{ (extra.precioExtra * extra.cantidad).toFixed(2) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Total -->
        <div class="card p-4 bg-orange-500 text-white">
          <div class="flex justify-between items-center">
            <span class="text-lg font-semibold">Total del Pedido:</span>
            <span class="text-3xl font-bold">${{ calcularTotal().toFixed(2) }}</span>
          </div>
        </div>
      </div>
    </app-section-container>
  </div>

  <!-- Botones -->
  <app-save-cancel [saveLabel]="'Crear Pedido'" [cancelLabel]="'Cancelar'" [loading]="loading"
    [disabled]="carrito.length === 0" [sticky]="true" (cancel)="cancel()">
  </app-save-cancel>
</form>
