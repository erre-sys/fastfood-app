<form class="form" (ngSubmit)="onSubmit()" autocomplete="off">
  <div class="space-y-6">
    <!-- Selección de Platos y Extras -->
    <app-section-container [heading]="'Seleccionar Platos'" [compact]="false" [divider]="true" [inset]="true">
      <div class="space-y-6">
        <!-- Plato y Cantidad -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 items-center">
          <app-select label="Plato" [formGroup]="platoForm" controlName="platoId" [items]="platos" [soft]="true"
            [disabled]="loading" [includeNull]="true" nullLabel="-- Seleccione un plato --" labelKey="nombre"
            valueKey="id">
          </app-select>

          <div class="flex justify-center items-center gap-3 mt-6">
            <button type="button" class="btn-icon btn-icon--sm btn-icon--outline"
              (click)="ajustarCantidad(platoForm, -1)" [disabled]="platoForm.controls.cantidad.value <= 1 || loading">
              <lucide-icon [img]="Minus" [size]="14"></lucide-icon>
            </button>
            <span class="font-semibold text-lg w-8 text-center">{{ platoForm.controls.cantidad.value }}</span>
            <button type="button" class="btn-icon btn-icon--sm btn-icon--outline"
              (click)="ajustarCantidad(platoForm, 1)" [disabled]="loading">
              <lucide-icon [img]="Plus" [size]="14"></lucide-icon>
            </button>
          </div>
        </div>

        <!-- Extras -->
        <div class="space-y-3">
          <label class="form-label">Ingredientes Adicionales</label>

          <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
            <div class="lg:col-span-6">
              <app-select [formGroup]="extraForm" controlName="ingredienteId" [items]="ingredientes" [soft]="true"
                [disabled]="loading" [includeNull]="true" nullLabel="-- Seleccione ingrediente --" labelKey="nombre"
                valueKey="id">
              </app-select>
            </div>

            <div class="lg:col-span-3">
              <app-input type="numeric" [formGroup]="extraForm" controlName="cantidad" [soft]="true"
                [disabled]="loading" [min]="1" placeholder="1">
              </app-input>
            </div>

            <div class="lg:col-span-3">
              <button type="button" class="btn btn--primary w-full" (click)="agregarExtraTemp()"
                [disabled]="!extraForm.controls.ingredienteId.value || extraForm.controls.cantidad.value <= 0 || loading">
                <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
                <span>Agregar</span>
              </button>
            </div>
          </div>

          <!-- Lista de extras temporales -->
          <div *ngIf="extrasTemp.length > 0" class="flex flex-wrap gap-2 mt-3">
            <div *ngFor="let extra of extrasTemp; let i = index"
              class="flex items-center gap-3 px-4 py-2 bg-slate-100 rounded-lg border border-slate-300">
              <span class="font-medium">{{ extra.ingredienteNombre }}</span>
              <span class="text-slate-600">×{{ extra.cantidad }}</span>
              <span class="text-blue-600 font-semibold">${{ (extra.precioExtra * extra.cantidad).toFixed(2) }}</span>
              <button type="button" class="btn-icon btn-icon--sm btn-icon--danger" (click)="removerExtraTemp(i)"
                [disabled]="loading" title="Quitar">
                <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Preview del precio -->
        <div *ngIf="platoForm.controls.platoId.value" class="card p-4 bg-blue-50 border-blue-200">
          <div class="flex justify-between items-center">
            <span class="font-semibold text-slate-700">Precio Total:</span>
            <span class="text-2xl font-bold text-blue-600">${{ calcularPrecioPreview().toFixed(2) }}</span>
          </div>
        </div>

        <!-- Botón Agregar al carrito -->
        <button type="button" class="btn w-full" (click)="agregarPlatoAlCarrito()"
          [disabled]="!platoForm.controls.platoId.value || platoForm.controls.cantidad.value <= 0 || loading">
          <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
          <span>Agregar al Pedido</span>
        </button>
      </div>
    </app-section-container>

    <!-- Carrito -->
    <app-section-container [heading]="'Carrito de Pedido'" [compact]="false" [divider]="true" [inset]="true">
      <div *ngIf="carrito.length === 0" class="text-center py-12 text-slate-400">
        <p class="font-medium">El carrito está vacío</p>
      </div>

      <div *ngIf="carrito.length > 0" class="space-y-4">
        <!-- Tabla del carrito -->
        <div class="table-wrap">
          <table class="table table--hover">
            <thead>
              <tr>
                <th>Plato</th>
                <th>Precio Unit.</th>
                <th class="text-center">Cantidad</th>
                <th>Extras</th>
                <th class="text-right">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of carrito; let i = index">
                <!-- Plato -->
                <td>
                  <div class="font-semibold">{{ item.platoNombre }}</div>
                </td>

                <!-- Precio unitario -->
                <td>
                  <span class="text-slate-600">${{ item.precioBase.toFixed(2) }}</span>
                </td>

                <!-- Cantidad con botones -->
                <td>
                  <div class="flex items-center justify-center gap-2">
                    <button type="button" class="btn-icon btn-icon--sm btn-icon--outline"
                      (click)="disminuirCantidad(item)" [disabled]="loading || item.cantidad <= 1">
                      <lucide-icon [img]="Minus" [size]="14"></lucide-icon>
                    </button>
                    <span class="font-bold text-base min-w-[2rem] text-center">{{ item.cantidad }}</span>
                    <button type="button" class="btn-icon btn-icon--sm btn-icon--outline"
                      (click)="aumentarCantidad(item)" [disabled]="loading">
                      <lucide-icon [img]="Plus" [size]="14"></lucide-icon>
                    </button>
                  </div>
                </td>

                <!-- Extras -->
                <td>
                  <div *ngIf="item.extras.length > 0" class="flex flex-wrap gap-1">
                    <span *ngFor="let extra of item.extras" class="pill pill--muted text-xs">
                      {{ extra.ingredienteNombre }} ×{{ extra.cantidad }}
                      <span class="text-orange-600 font-semibold ml-1">+${{ (extra.precioExtra *
                        extra.cantidad).toFixed(2) }}</span>
                    </span>
                  </div>
                  <span *ngIf="item.extras.length === 0" class="text-slate-400">-</span>
                </td>

                <!-- Subtotal -->
                <td class="text-right">
                  <span class="font-bold text-orange-600">${{ calcularSubtotal(item).toFixed(2) }}</span>
                </td>

                <!-- Acciones -->
                <td class="td--actions">
                  <button type="button" class="btn-icon btn-icon--sm btn-icon--danger" (click)="removerDelCarrito(i)"
                    [disabled]="loading" title="Eliminar">
                    <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Total usando el componente summary -->
        <app-summary [label]="'Total del Pedido'" [value]="'$' + calcularTotal().toFixed(2)" [variant]="'accent'"
          [icon]="ShoppingCart" [iconSize]="28" [size]="'md'">
        </app-summary>
      </div>
    </app-section-container>
  </div>

  <!-- Botones -->
  <app-save-cancel [saveLabel]="'Crear Pedido'" [cancelLabel]="'Cancelar'" [loading]="loading"
    [disabled]="carrito.length === 0" [sticky]="true" (cancel)="cancel()">
  </app-save-cancel>
</form>