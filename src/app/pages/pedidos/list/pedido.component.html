<app-page-layout [headerTemplate]="headerT" [contentTemplate]="contentT"></app-page-layout>

<!-- HEADER -->
<ng-template #headerT>
  <app-title [titleLabel]="titleLabel" [subtitle]="subTitleLabel" [showBack]="true" variant="tinted" tone="brand"
    (cancel)="goBack()">
    <ui-button [icon]="Plus" label="Nuevo Pedido" variant="primary" size="md" [to]="['/pedidos/nuevo']">
    </ui-button>
  </app-title>
</ng-template>

<!-- CONTENT -->
<ng-template #contentT>
  <!-- Tabs -->
  <app-tabs-filter [items]="[
    { key:'all', label:'Todos',     count:counters.all, tone:'brand'   },
    { key:'C',   label:'Creados',   count:counters.C,   tone:'warn'    },
    { key:'L',   label:'Listos',    count:counters.L,   tone:'brand'   },
    { key:'E',   label:'Entregados',count:counters.E,   tone:'success' },
    { key:'A',   label:'Anulados',  count:counters.A,   tone:'danger'  }
  ]" [active]="tab" (activeChange)="setTab($any($event))">
  </app-tabs-filter>

  <!-- Filtros de Búsqueda -->
  <app-section-container [heading]="'Filtros de Búsqueda'" [compact]="true" [inset]="true">
    <div class="fg">
        <app-date-range labelFrom="Fecha Desde" labelTo="Fecha Hasta" [valueFrom]="searchForm.controls.fechaDesde.value"
          [valueTo]="searchForm.controls.fechaHasta.value"
          (valueFromChange)="searchForm.controls.fechaDesde.setValue($event)"
          (valueToChange)="searchForm.controls.fechaHasta.setValue($event)" hintFrom="Inicio del rango"
          hintTo="Fin del rango">
        </app-date-range>
    </div>
  </app-section-container>

  <!-- Tabla Personalizada con Expansión -->
  <section aria-label="Listado de pedidos" class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
    <!-- Tabla -->
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
          <tr>
            <th class="px-3 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider w-12">
              <!-- Columna para expand -->
            </th>
            <th class="px-3 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider w-16">
              ID
            </th>
            <th class="px-3 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">
              Fecha
            </th>
            <th class="px-3 py-3 text-center text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider w-28">
              Estado
            </th>
            <th class="px-3 py-3 text-right text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider w-32">
              Total
            </th>
            <th class="px-3 py-3 text-right text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
          <ng-container *ngIf="loading">
            <tr>
              <td colspan="6" class="px-3 py-8 text-center">
                <div class="flex justify-center items-center">
                  <div class="skeleton h-8 w-full max-w-md"></div>
                </div>
              </td>
            </tr>
          </ng-container>

          <ng-container *ngIf="!loading && rows.length === 0">
            <tr>
              <td colspan="6" class="px-3 py-8 text-center text-slate-500">
                No hay pedidos registrados
              </td>
            </tr>
          </ng-container>

          <ng-container *ngFor="let pedido of rows">
            <!-- Fila Principal -->
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
              <!-- Botón Expandir -->
              <td class="px-3 py-3">
                <button type="button" (click)="toggleExpand(pedido)"
                  class="p-1 hover:bg-slate-200 dark:hover:bg-slate-600 rounded transition-colors"
                  [attr.aria-label]="isExpanded(pedido) ? 'Contraer detalles' : 'Expandir detalles'">
                  <lucide-icon [img]="isExpanded(pedido) ? ChevronUp : ChevronDown" [size]="20"></lucide-icon>
                </button>
              </td>

              <!-- ID -->
              <td class="px-3 py-3 text-sm font-medium text-slate-900 dark:text-slate-100">
                {{ pedido.id }}
              </td>

              <!-- Fecha -->
              <td class="px-3 py-3 text-sm text-slate-600 dark:text-slate-400">
                {{ pedido.creadoEn | date: 'dd/MM/yyyy HH:mm' }}
              </td>

              <!-- Estado -->
              <td class="px-3 py-3 text-center">
                <span class="pill" [ngClass]="{
                  'pill--warning': pedido.estado === 'C',
                  'pill--muted': pedido.estado === 'L',
                  'pill--success': pedido.estado === 'E',
                  'pill--danger': pedido.estado === 'A'
                }">
                  {{ pedido.estado === 'C' ? 'Creado' : pedido.estado === 'L' ? 'Listo' : pedido.estado === 'E' ? 'Entregado' : 'Anulado' }}
                </span>
              </td>

              <!-- Total -->
              <td class="px-3 py-3 text-sm font-semibold text-slate-900 dark:text-slate-100 text-right">
                {{ pedido.totalNeto | currency }}
              </td>

              <!-- Acciones -->
              <td class="px-3 py-3">
                <div class="flex gap-2 justify-end items-center">
                  <!-- Badge de completamente pagado -->
                  <span *ngIf="pedido.estado === 'E' && pedido.montoPendiente !== undefined && pedido.montoPendiente <= 0"
                    class="pill pill--success text-xs font-semibold">
                    ✓ Pagado
                  </span>

                  <ui-button [icon]="Eye" label="Ver" variant="warning" size="sm" [to]="['/pedidos', pedido.id, 'detalle']"
                    [ariaLabel]="'Ver detalle del pedido #' + pedido.id">
                  </ui-button>

                  <!-- C -> L (Creado a Listo) -->
                  <ui-button *ngIf="pedido.estado === 'C'" [icon]="Check" label="Listo" variant="outline" size="sm" type="button"
                    (clicked)="onMarcarListo(pedido)" [title]="'Marcar como Listo (NO descuenta inventario)'">
                  </ui-button>

                  <!-- L -> E (Listo a Entregado) -->
                  <ui-button *ngIf="pedido.estado === 'L'" [icon]="Check" label="Entregar" variant="outline" size="sm" type="button"
                    (clicked)="onEntregar(pedido)" [title]="'Entregar pedido (SÍ descuenta inventario)'">
                  </ui-button>

                  <!-- E -> Pagar (solo si NO tiene pagos registrados) -->
                  <ui-button *ngIf="pedido.estado === 'E' && !pedido.tienePagosRegistrados"
                    [icon]="DollarSign" label="Pagar" variant="primary" size="sm" type="button" (clicked)="onPagar(pedido)"
                    [title]="'Registrar pago del pedido'">
                  </ui-button>

                  <!-- Badge de pago registrado (pendiente de aprobación) -->
                  <span *ngIf="pedido.estado === 'E' && pedido.tienePagosRegistrados && pedido.montoPendiente !== undefined && pedido.montoPendiente > 0"
                    class="pill pill--warning text-xs font-semibold">
                    Pagado
                  </span>

                  <!-- C, L -> A (Anular) -->
                  <ui-button *ngIf="pedido.estado === 'C' || pedido.estado === 'L'" [icon]="XIcon" label="Anular" variant="outline" size="sm"
                    type="button" (clicked)="onAnular(pedido)" [title]="'Anular pedido'">
                  </ui-button>
                </div>
              </td>
            </tr>

            <!-- Fila Expandida (Detalles) -->
            <tr *ngIf="isExpanded(pedido)" class="bg-slate-50 dark:bg-slate-800/50">
              <td colspan="6" class="px-3 py-4">
                <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-4">
                  <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-3 flex items-center gap-2">
                    <lucide-icon [img]="Eye" [size]="18"></lucide-icon>
                    Detalles del Pedido #{{ pedido.id }}
                  </h4>

                  <!-- Items del Pedido -->
                  <div *ngIf="pedido.items && pedido.items.length > 0" class="space-y-3">
                    <div *ngFor="let item of pedido.items" class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-white dark:bg-slate-900">
                      <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                          <h5 class="font-medium text-slate-900 dark:text-slate-100">{{ item.platoNombre || 'Plato #' + item.platoId }}</h5>
                          <p class="text-sm text-slate-600 dark:text-slate-400">
                            Cantidad: <span class="font-semibold">{{ item.cantidad }}</span> ×
                            <span class="font-semibold">{{ item.precioUnitario | currency }}</span> =
                            <span class="font-semibold text-orange-600">{{ (item.precioUnitario! * item.cantidad) | currency }}</span>
                          </p>
                        </div>
                        <div class="text-right">
                          <p class="text-lg font-bold text-orange-600">{{ calcularSubtotalItem(item) | currency }}</p>
                        </div>
                      </div>

                      <!-- Descuento -->
                      <div *ngIf="item.descuentoPct && item.descuentoPct > 0" class="mb-2 p-2 bg-green-50 dark:bg-green-900/20 rounded text-sm">
                        <span class="font-medium text-green-700 dark:text-green-400">Descuento:</span>
                        <span class="text-green-600 dark:text-green-300">{{ item.descuentoPct }}% (-{{ item.descuentoMonto | currency }})</span>
                      </div>

                      <!-- Extras -->
                      <div *ngIf="item.extras && item.extras.length > 0" class="border-t border-slate-200 dark:border-slate-700 pt-2 mt-2">
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-2">Extras:</p>
                        <div class="flex flex-wrap gap-2">
                          <span *ngFor="let extra of item.extras"
                            class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs border border-slate-200 dark:border-slate-600">
                            <span class="font-medium">{{ extra.ingredienteNombre || 'Extra #' + extra.ingredienteId }}</span>
                            <span class="text-slate-600 dark:text-slate-400"> ×{{ extra.cantidad }}</span>
                            <span class="text-orange-600 font-semibold ml-1">+{{ ((extra.precioExtra || 0) * (extra.cantidad || 0)) | currency }}</span>
                            <span class="text-slate-500 dark:text-slate-400 text-xs ml-1">(×{{ item.cantidad }})</span>
                          </span>
                        </div>
                        <div *ngIf="calcularTotalExtrasItem(item) > 0" class="mt-2 text-right text-sm">
                          <span class="font-medium text-slate-600 dark:text-slate-400">Total Extras: </span>
                          <span class="font-bold text-orange-600">+{{ calcularTotalExtrasItem(item) | currency }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Sin items -->
                  <div *ngIf="!pedido.items || pedido.items.length === 0" class="text-center py-4 text-slate-500 dark:text-slate-400 text-sm italic">
                    Este pedido no tiene items cargados
                  </div>

                  <!-- Totales -->
                  <div class="mt-4 pt-4 border-t-2 border-orange-200 dark:border-orange-800">
                    <div class="space-y-2">
                      <div class="flex justify-between items-center text-sm">
                        <span class="font-medium text-slate-700 dark:text-slate-300">Subtotal (Platos):</span>
                        <span class="font-semibold">{{ pedido.totalBruto | currency }}</span>
                      </div>
                      <div *ngIf="pedido.totalExtras > 0" class="flex justify-between items-center text-sm">
                        <span class="font-medium text-slate-700 dark:text-slate-300">Total Extras:</span>
                        <span class="font-semibold text-orange-600">+{{ pedido.totalExtras | currency }}</span>
                      </div>
                      <div class="flex justify-between items-center pt-2 border-t border-slate-200 dark:border-slate-700">
                        <span class="text-lg font-bold text-slate-800 dark:text-slate-100">Total:</span>
                        <span class="text-2xl font-bold text-orange-600">{{ pedido.totalNeto | currency }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Paginación -->
  <app-paginator class="mt-2" [from]="from()" [to]="to()" [total]="total" [pageIndex]="page" [pageSize]="pageSize"
    [pageSizeOptions]="[10,20,30,50]" [maxPage]="maxPage()" (sizeChange)="setPageSize($event)" (prev)="prev()"
    (next)="next()">
  </app-paginator>
</ng-template>