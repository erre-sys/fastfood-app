<app-page-layout [headerTemplate]="headerT" [contentTemplate]="contentT"></app-page-layout>

<!-- HEADER -->
<ng-template #headerT>
  <app-title [titleLabel]="titleLabel" [subtitle]="subTitleLabel" [showBack]="true" variant="tinted" tone="brand"
    (cancel)="goBack()">
    <ui-button [icon]="Plus" label="Nuevo Pedido" variant="primary" size="md" [to]="['/pedidos/nuevo']">
    </ui-button>
  </app-title>
</ng-template>

<!-- CONTENT -->
<ng-template #contentT>
  <!-- Tabs -->
  <app-tabs-filter [items]="[
    { key:'all', label:'Todos',     count:counters.all, tone:'brand'   },
    { key:'C',   label:'Creados',   count:counters.C,   tone:'warn'    },
    { key:'L',   label:'Listos',    count:counters.L,   tone:'brand'   },
    { key:'E',   label:'Entregados',count:counters.E,   tone:'success' },
    { key:'A',   label:'Anulados',  count:counters.A,   tone:'danger'  }
  ]" [active]="tab" (activeChange)="setTab($any($event))">
  </app-tabs-filter>

  <!-- Filtros de Búsqueda -->
  <app-section-container [heading]="'Filtros de Búsqueda'" [compact]="true" [inset]="true">
    <div class="fg">
        <app-date-range labelFrom="Fecha Desde" labelTo="Fecha Hasta" [valueFrom]="searchForm.controls.fechaDesde.value"
          [valueTo]="searchForm.controls.fechaHasta.value"
          (valueFromChange)="searchForm.controls.fechaDesde.setValue($event)"
          (valueToChange)="searchForm.controls.fechaHasta.setValue($event)" hintFrom="Inicio del rango"
          hintTo="Fin del rango">
        </app-date-range>
    </div>
  </app-section-container>

  <!-- Tabla -->
  <app-table [columns]="columns" [rows]="rows" [loading]="loading" [emptyText]="'No hay pedidos registrados'"
    [sort]="{ key: sortKey, dir: sortDir }" (sortChange)="onSort($event)" [actionsTpl]="actionsTpl">
    <ng-template #actionsTpl let-r>

      <!-- Badge de completamente pagado -->
      <span *ngIf="r.estado === 'E' && r.montoPendiente !== undefined && r.montoPendiente <= 0"
        class="pill pill--success text-xs font-semibold">
        ✓ Pagado
      </span>

      <ui-button [icon]="Eye" label="Ver" variant="warning" size="sm" [to]="['/pedidos', r.id, 'detalle']"
        [ariaLabel]="'Ver detalle del pedido #' + r.id">
      </ui-button>


      <!-- C -> L (Creado a Listo) - NO descuenta inventario -->
      <ui-button *ngIf="r.estado === 'C'" [icon]="Check" label="Listo" variant="outline" size="sm" type="button"
        (clicked)="onMarcarListo(r)" [title]="'Marcar como Listo (NO descuenta inventario)'">
      </ui-button>

      <!-- L -> E (Listo a Entregado) - SÍ descuenta inventario -->
      <ui-button *ngIf="r.estado === 'L'" [icon]="Check" label="Entregar" variant="outline" size="sm" type="button"
        (clicked)="onEntregar(r)" [title]="'Entregar pedido (SÍ descuenta inventario)'">
      </ui-button>

      <!-- E -> Pagar (Solo pedidos entregados y con saldo pendiente) -->
      <ui-button *ngIf="r.estado === 'E' && (r.montoPendiente === undefined || r.montoPendiente > 0)"
        [icon]="DollarSign" label="Pagar" variant="primary" size="sm" type="button" (clicked)="onPagar(r)"
        [title]="'Registrar pago del pedido'">
      </ui-button>

      <!-- C, L -> A (Anular) -->
      <ui-button *ngIf="r.estado === 'C' || r.estado === 'L'" [icon]="XIcon" label="Anular" variant="outline" size="sm"
        type="button" (clicked)="onAnular(r)" [title]="'Anular pedido'">
      </ui-button>
    </ng-template>
  </app-table>

  <!-- Paginación -->
  <app-paginator class="mt-2" [from]="from()" [to]="to()" [total]="total" [pageIndex]="page" [pageSize]="pageSize"
    [pageSizeOptions]="[10,20,30,50]" [maxPage]="maxPage()" (sizeChange)="setPageSize($event)" (prev)="prev()"
    (next)="next()">
  </app-paginator>
</ng-template>