<form class="form" [formGroup]="form" (ngSubmit)="onSubmit()" autocomplete="off">
  <!-- Información del Plato -->
  <app-section-container [heading]="'Receta: ' + platoNombre" [compact]="true" [divider]="true" [inset]="true">
    <p class="form-help">
      Define los ingredientes y cantidades necesarias para preparar este plato.
    </p>
  </app-section-container>

  <!-- Resumen de ingredientes -->
  <app-section-container *ngIf="getTotalIngredientes() > 0" [heading]="'Resumen de Ingredientes'"
    [compact]="true" [divider]="true" [inset]="true">
    <app-table [columns]="resumenColumns" [rows]="getResumenIngredientes()"
      [emptyText]="'No hay ingredientes en la receta'">
    </app-table>
  </app-section-container>

  <!-- Items de Receta -->
  <app-section-container [heading]="'Ingredientes'" [compact]="true" [divider]="true" [inset]="true"
    [actionsTpl]="headerActions">
    <ng-template #headerActions>
      <ui-button label="Agregar Ingrediente" [icon]="Plus" variant="primary" size="sm"
        (clicked)="agregarItem()" [disabled]="loading">
      </ui-button>
    </ng-template>

    <div formArrayName="items" class="fg">
      <!-- Cada item -->
      <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="card">
        <button type="button" (click)="removerItem(i)" class="btn-icon btn-icon--sm btn-icon--danger"
          title="Remover ingrediente" [disabled]="loading">
          <lucide-icon [img]="X" [size]="16"></lucide-icon>
        </button>

        <div class="fg">
          <app-select [label]="'Ingrediente'" [formGroup]="$any(item)" controlName="ingredienteId"
            [items]="ingredientesValidos" labelKey="nombre" valueKey="id" [required]="true" [soft]="true"
            [disabled]="loading" [includeNull]="true" nullLabel="Seleccionar ingrediente">
          </app-select>

          <app-input [label]="'Cantidad'" type="numeric" [formGroup]="$any(item)" controlName="cantidad"
            [required]="true" [soft]="true" [disabled]="loading" [step]="0.001" [min]="0.0001" placeholder="1.000">
          </app-input>

          <span *ngIf="item.get('ingredienteId')?.value" class="form-help">
            Unidad: {{ getUnidadIngrediente(item.get('ingredienteId')?.value) || '—' }}
          </span>
        </div>
      </div>

      <!-- Mensaje vacío -->
      <div *ngIf="items.length === 0" class="empty-state">
        No hay ingredientes en la receta. Haga clic en "Agregar Ingrediente" para comenzar.
      </div>
    </div>
  </app-section-container>

  <!-- Botones -->
  <app-save-cancel [saveLabel]="'Guardar Receta'" [cancelLabel]="'Cancelar'" [loading]="loading"
    [disabled]="items.length === 0" [sticky]="true" (cancel)="cancel()">
  </app-save-cancel>
</form>